
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for the admin custom claim on the user's token.
    function isAdmin() {
      return request.auth.token.admin == true;
    }

    // This single rule allows a user to read and write to their own document
    // and any sub-documents (like application drafts, quiz results, etc.).
    // It ALSO allows an admin to READ any user's data, which is required
    // for the admin dashboard queries to work correctly.
    match /users/{userId}/{path=**} {
      allow write: if request.auth.uid == userId;
      allow read: if request.auth.uid == userId || isAdmin();
    }

    // Rules for the top-level 'applications' collection, which holds
    // finalized submissions.
    match /applications/{appId} {
      // A user can create their application record upon final submission.
      allow create: if request.auth.uid == request.resource.data.userId;

      // A user can read their own submitted application, and an admin can read any.
      allow read: if request.auth.uid == resource.data.userId || isAdmin();

      // Only an admin can update or delete a submitted application.
      allow update, delete: if isAdmin();
    }

    // This rule is specifically for the admin's `collectionGroup('application')` query.
    // It ensures that any query scanning across all 'application' collections
    // is only allowed if the user is an admin.
    match /{path=**}/application/{docId} {
      allow read: if isAdmin();
    }

    // Rules for other admin-only collections
    match /settings/{docId} {
      allow read, write: if isAdmin();
    }
    match /news/{docId} {
      allow read, write: if isAdmin();
    }
  }
}
