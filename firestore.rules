
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAdmin() {
      return request.auth.token.admin == true;
    }

    // USER DATA: Users can only access their own data. Admins can access anyone's.
    // This also protects the 'application/draft' sub-collection.
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth.uid == userId || isAdmin();
    }

    // SUBMITTED APPLICATIONS: Admins have full control. Users can only read their own.
    match /applications/{applicationId} {
      // Admins can perform any write operation.
      allow write: if isAdmin();
      
      // Allow a user to get their own application document. Admins can get any.
      allow get: if request.auth.uid == resource.data.userId || isAdmin();
      
      // Only admins can list all applications.
      allow list: if isAdmin();

      // STATUS HISTORY: Users need to be able to read this for their own application.
      match /statusHistory/{historyId} {
        // Allow read if the user owns the parent application or is an admin.
        allow read: if request.auth.uid == get(/databases/$(database)/documents/applications/$(applicationId)).data.userId || isAdmin();
        // Only admins can create/update status history.
        allow write: if isAdmin();
      }
    }
    
    // APPOINTMENTS: Users can create their own, admins can manage all.
    match /appointments/{appointmentId} {
      allow create: if request.auth.uid != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth.uid == resource.data.userId || isAdmin();
      allow update, delete: if isAdmin();
    }

    // SETTINGS & NEWS: Admins have full control, users can read.
    match /settings/{docId} {
        allow read: if request.auth.uid != null;
        allow write: if isAdmin();
    }
    match /news/{newsId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // COLLECTION GROUP QUERIES: Used by admin pages.
    match /{path=**}/application/{applicationId} {
      allow read: if isAdmin();
    }
  }
}
